# PasteMark - VSCode 插件需求文档

## 项目概述

PasteMark 是一个智能的 VSCode 插件，用于在 Markdown 文件中快速粘贴剪贴板中的图片。插件支持两种使用模式：手动命名模式（通过选中文本）和智能命名模式（通过 Ollama 多模态大模型生成语义化文件名）。

## 技术要求

- **开发语言**: TypeScript
- **运行环境**: WSL2 on Windows
- **目标平台**: Visual Studio Code
- **可选依赖**: Ollama 本地服务（用于智能图片命名）
- **最小化实现**: 核心功能不依赖外部服务

## 核心功能

### 1. 手动命名模式（选中文本）

**触发条件**:
- 用户在 `.md` 文件中选中文本
- 剪贴板中包含图片数据
- 用户按下 `Ctrl+Alt+V` 快捷键

**执行流程**:
1. 检测当前文件是否为 Markdown 文件
2. 获取用户选中的文本作为图片文件名
3. 读取剪贴板中的图片数据
4. 使用选中的文本作为文件名（如：`选中的文本.png`）
5. 将图片保存到当前 Markdown 文件的同级目录
6. 将选中的文本替换为 `![选中的文本](./选中的文本.png)`

### 2. 智能命名模式（未选中文本）

**触发条件**:
- 用户在 `.md` 文件中，光标定位但未选中文本
- 剪贴板中包含图片数据
- 用户按下 `Ctrl+Alt+V` 快捷键

**执行流程**:
1. 检测当前文件是否为 Markdown 文件
2. 读取剪贴板中的图片数据
3. 尝试调用 Ollama 服务：
   - **成功**: 使用多模态大模型分析图片内容，生成语义化文件名
   - **失败**: 生成随机文件名（如：`image-20250115-122010.png`）
4. 将图片保存到当前 Markdown 文件的同级目录
5. 在光标位置插入 `![图片描述](./生成的文件名.png)`

### 3. Ollama 集成（可选）

**配置项**:
- `pastemark.ollamaEndpoint`: Ollama 服务地址（默认：`http://localhost:11434`）
- `pastemark.ollamaModel`: 使用的模型名称（默认：`llava`）
- `pastemark.ollamaEnabled`: 是否启用 Ollama 智能命名（默认：`true`）

**图片分析提示词**:
- 分析图片内容并生成简短、描述性的文件名
- 文件名应该是英文，使用连字符分隔单词
- 保持简洁，通常 2-4 个单词

### 4. 错误处理

- 剪贴板中无图片时提示用户
- 文件保存失败时提示错误信息
- 非 Markdown 文件中使用时提示不支持

## 用户交互

### 快捷键
- `Ctrl+Alt+V`: 粘贴剪贴板图片

### 提示信息
- 成功：显示"图片已保存：[文件名]"
- 失败：显示具体错误原因

## 文件组织

```
当前markdown文件.md
选中的文本.png              # 手动命名模式生成的图片
architecture-diagram.png    # Ollama 智能命名生成的图片
user-interface-flow.png     # Ollama 智能命名生成的图片
image-20250115-122010.png  # 随机命名生成的图片（Ollama 不可用时）
```

## 非功能性需求

1. **性能**: 
   - 图片保存和替换操作应在 1 秒内完成
   - Ollama 调用超时时间设置为 3 秒，超时后降级为随机命名
2. **兼容性**: 支持 WSL2 环境下的剪贴板操作
3. **稳定性**: 处理大图片（10MB以内）时不应崩溃
4. **用户体验**: 
   - 操作流畅，错误提示清晰
   - Ollama 服务不可用时自动降级，不影响核心功能

## 实现约束

1. 最小化依赖，仅使用必要的 npm 包
2. 代码简洁，易于维护
3. 遵循 VSCode 插件开发最佳实践
4. TypeScript 严格模式开发

## 未来扩展（本次不实现）

- 支持自定义图片保存路径
- 支持图片格式转换
- 支持拖拽粘贴
- 支持批量处理